<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigramme Dynamique</title>
    <!-- Biblioth√®que pour lire les fichiers Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Biblioth√®que pour cr√©er des graphes interactifs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .upload-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-box {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-indicator.loading {
            background: #fff3bf;
            color: #856404;
        }

        .status-indicator.success {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .status-indicator.error {
            background: #ffe3e3;
            color: #c92a2a;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-name {
            color: #495057;
            font-style: italic;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 300px);
            min-height: 600px;
        }

        #network {
            flex: 1;
            border-right: 2px solid #e9ecef;
            position: relative;
        }

        .info-panel {
            width: 400px;
            padding: 30px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .info-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .info-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-item {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .info-item strong {
            color: #667eea;
        }

        .relation-item {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .relation-photo {
            width: 100%;
            border-radius: 6px;
            margin-top: 10px;
        }

        .article-item {
            background: #e7f5ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .article-item:hover {
            transform: translateX(5px);
            background: #d0ebff;
        }

        .debunk-item {
            background: #fff3bf;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #ffd43b;
        }

        .person-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 4px solid #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #868e96;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .breadcrumb {
            padding: 15px 30px;
            background: #e9ecef;
            font-size: 0.9em;
            color: #495057;
        }

        .breadcrumb span {
            cursor: pointer;
            color: #667eea;
        }

        .breadcrumb span:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Organigramme Dynamique</h1>
            <p>Explore les relations et connections de mani√®re interactive ü§ì</p>
        </div>

        <div class="upload-section">
            <div class="status-indicator" id="statusIndicator">
                <div class="spinner"></div>
                <span>Chargement des donn√©es...</span>
            </div>
            <div class="upload-box">
                <div class="file-input-wrapper">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" />
                    <label for="excelFile" class="file-input-label">
                        üîÑ Charger un autre fichier
                    </label>
                </div>
            </div>
        </div>

        <div class="breadcrumb" id="breadcrumb">
            <span onclick="resetView()">üè† Accueil</span>
        </div>

        <div class="main-content">
            <div id="network"></div>
            <div class="info-panel">
                <div class="empty-state">
                    <div style="font-size: 4em;">üëÜ</div>
                    <p>Cliquez sur un √©l√©ment pour voir ses informations ; utilise le menu pour revenir en arri√®re</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        
        // Stockage des donn√©es Excel
        let personnesData = [];
        let articlesData = [];
        let relationsData = [];
        let debunksData = [];
        
        // Variables pour le r√©seau
        let network = null;
        let nodes = null;
        let edges = null;
        
        // Navigation, pour savoir o√π on est dans l'arborescence
        let currentView = 'sections'; // 'sections', 'persons', 'articles'
        let currentSection = null;
        let currentPerson = null;
        let currentArticle = null;

        // ========================================
        // CHARGEMENT AUTOMATIQUE AU D√âMARRAGE
        // ========================================
        
        // charge automatiquement le fichier data.xlsx
        // !!! IMPORTANT : Le fichier data.xlsx doit √™tre dans le m√™me dossier que index.html attention !!!!
        async function loadDefaultData() {
            updateStatus('loading', 'Chargement des donn√©es...');
            
            try {
                // Charger le fichier data.xlsx depuis le github
                const response = await fetch('data.xlsx');
                
                if (!response.ok) {
                    throw new Error('Fichier data.xlsx introuvable. Assurez-vous qu\'il est dans le m√™me dossier.');
                }
                
                // Convertir la r√©ponse en ArrayBuffer askiparait
                const arrayBuffer = await response.arrayBuffer();
                
                // Traiter le fichier Excel 
                processExcelData(arrayBuffer);
                
                updateStatus('success', '‚úì Donn√©es charg√©es avec succ√®s');
                
            } catch (error) {
                console.error('Erreur:', error);
                updateStatus('error', '‚úó Erreur: ' + error.message);
            }
        }

        // ========================================
        // M√†J du statut en mode frais 
        // ========================================
        
        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = 'status-indicator ' + type;
            
            if (type === 'loading') {
                indicator.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
            } else {
                indicator.innerHTML = '<span>' + message + '</span>';
            }
        }

        // ========================================
        // upload un autre fichier manuellement (pour test update)
        // ========================================
        
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            updateStatus('loading', 'Chargement de ' + file.name + '...');
            
            // Cr√©er un lecteur de fichier
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    processExcelData(e.target.result);
                    updateStatus('success', '‚úì ' + file.name + ' charg√© avec succ√®s');
                } catch (error) {
                    updateStatus('error', '‚úó Erreur: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        // ========================================
        // Traitement de l'excel
        // ========================================
        
        function processExcelData(arrayBuffer) {
            // Lire le fichier Excel
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Extraire les donn√©es de chaque feuille
            // La fonction XLSX.utils.sheet_to_json convertit une feuille Excel en tabler d'objets JavaScript, j'ai pas tout capt√©
            personnesData = XLSX.utils.sheet_to_json(workbook.Sheets['Personnes'] || workbook.Sheets[workbook.SheetNames[0]] || {});
            articlesData = XLSX.utils.sheet_to_json(workbook.Sheets['Articles'] || {});
            relationsData = XLSX.utils.sheet_to_json(workbook.Sheets['Relations'] || {});
            debunksData = XLSX.utils.sheet_to_json(workbook.Sheets['Debunks'] || {});
            
            console.log('Donn√©es charg√©es:', {
                personnes: personnesData.length,
                articles: articlesData.length,
                relations: relationsData.length,
                debunks: debunksData.length
            });
            
            // Initialiser l'affichage
            initializeNetwork();
            showSections();
        }

        // ========================================
        // initialisation du r√©seau et des nodes
        // ========================================
        
        function initializeNetwork() {
            const container = document.getElementById('network');
            
            // Configuration des options du r√©seau
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 25,
                    font: {
                        size: 16,
                        color: '#333'
                    },
                    borderWidth: 3,
                    shadow: true
                },
                edges: {
                    width: 2,
                    shadow: true,
                    smooth: {
                        type: 'continuous'
                    }
                },
                physics: {
                    enabled: true,
                    stabilization: {
                        iterations: 100
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        springLength: 150,
                        springConstant: 0.04
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };
            
            // Cr√©er le r√©seau
            const data = { nodes: [], edges: [] };
            network = new vis.Network(container, data, options);
            
            // G√©rer les clics sur les nodes
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    handleNodeClick(params.nodes[0]);
                }
            });
        }

        // ========================================
        // Affichage section 
        // ========================================
        
        function showSections() {
            currentView = 'sections';
            updateBreadcrumb();
            
            // Extraire les sections uniques des personnes (plusieurs sections ?)
            const sections = [...new Set(personnesData.map(p => p.Section))].filter(s => s);
            
            if (sections.length === 0) {
                clearInfoPanel();
                updateNetwork([], []);
                return;
            }
            
            // Cr√©er les nodes pour chaque section (1 atm)
            const nodesArray = sections.map((section, index) => ({
                id: 'section_' + section,
                label: section,
                color: {
                    background: '#667eea',
                    border: '#764ba2'
                },
                font: { color: 'white', size: 18 }
            }));
            
            // Pas de liens entre les sections
            const edgesArray = [];
            
            updateNetwork(nodesArray, edgesArray);
            clearInfoPanel();
        }

        // ========================================
        // AFFICHAGE DES PERSONNES D'UNE SECTION
        // ========================================
        
        function showPersonsInSection(section) {
            currentView = 'persons';
            currentSection = section;
            updateBreadcrumb();
            
            // Filtrer les personnes de cette section
            const persons = personnesData.filter(p => p.Section === section);
            
            // Cr√©er les n≈ìuds pour chaque personne
            const nodesArray = persons.map(person => ({
                id: 'person_' + person.ID,
                label: person.Nom,
                title: person.Fonction, // Info-bulle au survol en fraaaiiissss
                color: {
                    background: '#51cf66',
                    border: '#37b24d'
                },
                font: { color: 'black' }
            }));
            
            // Cr√©er des liens bas√©s sur les relations
            const edgesArray = [];
            persons.forEach(person => {
                const personRelations = relationsData.filter(r => 
                    (r.Personne1_ID == person.ID || r.Personne2_ID == person.ID) &&
                    persons.find(p => p.ID == r.Personne1_ID || p.ID == r.Personne2_ID)
                );
                
                personRelations.forEach(rel => {
                    edgesArray.push({
                        from: 'person_' + rel.Personne1_ID,
                        to: 'person_' + rel.Personne2_ID,
                        label: rel.Type,
                        color: { color: '#868e96' }
                    });
                });
            });
            
            updateNetwork(nodesArray, edgesArray);
            clearInfoPanel();
        }

        // ========================================
        // AFFICHAGE DES ARTICLES D'UNE PERSONNE
        // ========================================
        
        function showArticlesOfPerson(personId) {
            currentView = 'articles';
            currentPerson = personnesData.find(p => p.ID == personId);
            updateBreadcrumb();
            
            // Filtrer les articles de cette personne
            const articles = articlesData.filter(a => a.Auteur_ID == personId);
            
            // Cr√©er un n≈ìud pour la personne au centre
            const nodesArray = [{
                id: 'person_' + personId,
                label: currentPerson.Nom,
                color: {
                    background: '#51cf66',
                    border: '#37b24d'
                },
                font: { color: 'white', size: 20 },
                size: 35
            }];
            
            // Cr√©er les n≈ìuds pour chaque article
            articles.forEach(article => {
                nodesArray.push({
                    id: 'article_' + article.ID,
                    label: article.Titre.substring(0, 30) + '...',
                    title: article.Titre,
                    color: {
                        background: '#339af0',
                        border: '#1971c2'
                    },
                    font: { color: 'white' }
                });
            });
            
            // Cr√©er les liens entre la personne et ses articles
            const edgesArray = articles.map(article => ({
                from: 'person_' + personId,
                to: 'article_' + article.ID,
                color: { color: '#868e96' }
            }));
            
            updateNetwork(nodesArray, edgesArray);
            
            // Afficher les infos de la personne
            showPersonInfo(personId);
        }

        // ========================================
        // MISE √Ä JOUR DU R√âSEAU
        // ========================================
        
        function updateNetwork(nodesArray, edgesArray) {
            if (!network) return;
            
            // Mettre √† jour les donn√©es du r√©seau
            const data = {
                nodes: new vis.DataSet(nodesArray),
                edges: new vis.DataSet(edgesArray)
            };
            
            network.setData(data);
        }

        // ========================================
        // Gestion des clics sur les nodes
        // ========================================
        
        function handleNodeClick(nodeId) {
            console.log('Clic sur:', nodeId);
            
            // Griser tous les n≈ìuds sauf celui cliqu√© (pas certain que √ßa fonctionne)
            highlightNode(nodeId);
            
            if (nodeId.startsWith('section_')) {
                // Clic sur une section -> afficher les personnes
                const section = nodeId.replace('section_', '');
                showPersonsInSection(section);
                
            } else if (nodeId.startsWith('person_')) {
                // Clic sur une personne
                const personId = nodeId.replace('person_', '');
                
                if (currentView === 'persons') {
                    // Si on est dans la vue des personnes -> afficher les articles
                    showArticlesOfPerson(personId);
                } else {
                    // Sinon juste afficher les infos
                    showPersonInfo(personId);
                }
                
            } else if (nodeId.startsWith('article_')) {
                // Clic sur un article -> afficher les infos
                const articleId = nodeId.replace('article_', '');
                showArticleInfo(articleId);
            }
        }

        // ========================================
        // Mise en √©vidence d'un node grise les autres (??)
        // ========================================
        
        function highlightNode(nodeId) {
            if (!network) return;
            
            const allNodes = network.body.data.nodes.get();
            const connectedNodes = network.getConnectedNodes(nodeId);
            const connectedEdges = network.getConnectedEdges(nodeId);
            
            // Griser tous les nodes
            allNodes.forEach(node => {
                if (node.id === nodeId) {
                    // Le node cliqu√© reste normal
                    network.body.data.nodes.update({
                        id: node.id,
                        opacity: 1
                    });
                } else if (connectedNodes.includes(node.id)) {
                    // Les nodes connect√©s sont l√©g√®rement gris√©s
                    network.body.data.nodes.update({
                        id: node.id,
                        opacity: 0.6
                    });
                } else {
                    // Les autres sont tr√®s gris√©s (???? zebiiii)
                    network.body.data.nodes.update({
                        id: node.id,
                        opacity: 0.2
                    });
                }
            });
            
            // G√©rer l'opacit√© des liens (pas convaincu)
            const allEdges = network.body.data.edges.get();
            allEdges.forEach(edge => {
                if (connectedEdges.includes(edge.id)) {
                    network.body.data.edges.update({
                        id: edge.id,
                        opacity: 1
                    });
                } else {
                    network.body.data.edges.update({
                        id: edge.id,
                        opacity: 0.1
                    });
                }
            });
        }

        // ========================================
        // Affichage des infos d'une personne 
        // ========================================
        
        function showPersonInfo(personId) {
            const person = personnesData.find(p => p.ID == personId);
            if (!person) return;
            
            // Trouver les relations de cette personne
            const relations = relationsData.filter(r => 
                r.Personne1_ID == personId || r.Personne2_ID == personId
            );
            
            // Trouver les articles de cette personne
            const articles = articlesData.filter(a => a.Auteur_ID == personId);
            
            let html = '<h2>' + person.Nom + '</h2>';
            
            // Photo si disponible
            if (person.Photo_URL) {
                html += '<img src="' + person.Photo_URL + '" class="person-photo" alt="' + person.Nom + '">';
            }
            
            // Informations de base
            html += '<div class="info-section">';
            html += '<h3>Informations</h3>';
            html += '<div class="info-item"><strong>Fonction:</strong> ' + (person.Fonction || 'N/A') + '</div>';
            html += '<div class="info-item"><strong>Section:</strong> ' + (person.Section || 'N/A') + '</div>';
            if (person.Bio) {
                html += '<div class="info-item"><strong>Bio:</strong> ' + person.Bio + '</div>';
            }
            html += '</div>';
            
            // Relations
            if (relations.length > 0) {
                html += '<div class="info-section">';
                html += '<h3>Relations (' + relations.length + ')</h3>';
                relations.forEach(rel => {
                    const otherId = rel.Personne1_ID == personId ? rel.Personne2_ID : rel.Personne1_ID;
                    const otherPerson = personnesData.find(p => p.ID == otherId);
                    
                    html += '<div class="relation-item">';
                    html += '<strong>' + (otherPerson ? otherPerson.Nom : 'Inconnu') + '</strong><br>';
                    html += 'Type: ' + rel.Type + '<br>';
                    if (rel.Description) {
                        html += rel.Description + '<br>';
                    }
                    if (rel.Photo_URL) {
                        html += '<img src="' + rel.Photo_URL + '" class="relation-photo" alt="Relation">';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Articles
            if (articles.length > 0) {
                html += '<div class="info-section">';
                html += '<h3>Articles (' + articles.length + ')</h3>';
                articles.forEach(article => {
                    html += '<div class="article-item" onclick="showArticleInfo(' + article.ID + ')">';
                    html += '<strong>' + article.Titre + '</strong><br>';
                    if (article.Date) {
                        html += '<small>' + article.Date + '</small>';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            
            document.querySelector('.info-panel').innerHTML = html;
        }

        // ========================================
        // Affichage des infos d'un article 
        // ========================================
        
        function showArticleInfo(articleId) {
            const article = articlesData.find(a => a.ID == articleId);
            if (!article) return;
            
            // Trouver les d√©bunks de cet article
            const debunks = debunksData.filter(d => d.Article_ID == articleId);
            
            // Trouver l'auteur
            const author = personnesData.find(p => p.ID == article.Auteur_ID);
            
            let html = '<h2>üì∞ Article</h2>';
            
            html += '<div class="info-section">';
            html += '<h3>' + article.Titre + '</h3>';
            if (article.Date) {
                html += '<div class="info-item"><strong>Date:</strong> ' + article.Date + '</div>';
            }
            if (author) {
                html += '<div class="info-item"><strong>Auteur:</strong> ' + author.Nom + '</div>';
            }
            if (article.Description) {
                html += '<div class="info-item">' + article.Description + '</div>';
            }
            if (article.URL) {
                html += '<div class="info-item"><a href="' + article.URL + '" target="_blank">üîó Lire l\'article</a></div>';
            }
            html += '</div>';
            
            // D√©bunks ou pr√©cisions
            if (debunks.length > 0) {
                html += '<div class="info-section">';
                html += '<h3>‚ö†Ô∏è D√©bunks et pr√©cisions (' + debunks.length + ')</h3>';
                debunks.forEach(debunk => {
                    const debunkArticle = articlesData.find(a => a.ID == debunk.Article_Debunk_ID);
                    if (debunkArticle) {
                        html += '<div class="debunk-item">';
                        html += '<strong>' + debunk.Type + '</strong><br>';
                        html += debunkArticle.Titre + '<br>';
                        if (debunkArticle.URL) {
                            html += '<a href="' + debunkArticle.URL + '" target="_blank">üîó Voir</a>';
                        }
                        html += '</div>';
                    }
                });
                html += '</div>';
            }
            
            document.querySelector('.info-panel').innerHTML = html;
        }

        // ========================================
        // UTILITAIRES
        // ========================================
        
        function clearInfoPanel() {
            document.querySelector('.info-panel').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 4em;">üëÜ</div>
                    <p>Cliquez sur un √©l√©ment pour voir ses informations</p>
                </div>
            `;
        }

        function updateBreadcrumb() {
            let breadcrumb = '<span onclick="resetView()">üè† Accueil</span>';
            
            if (currentSection) {
                breadcrumb += ' > <span onclick="showPersonsInSection(\'' + currentSection + '\')">' + currentSection + '</span>';
            }
            
            if (currentPerson) {
                breadcrumb += ' > <span onclick="showArticlesOfPerson(' + currentPerson.ID + ')">' + currentPerson.Nom + '</span>';
            }
            
            document.getElementById('breadcrumb').innerHTML = breadcrumb;
        }

        function resetView() {
            currentSection = null;
            currentPerson = null;
            currentArticle = null;
            
            if (personnesData.length > 0) {
                showSections();
            } else {
                clearInfoPanel();
                if (network) {
                    updateNetwork([], []);
                }
            }
        }

        // ========================================
        // INITIALISATION AU CHARGEMENT DE LA PAGE
        // ========================================
        
        // Charger automatiquement les donn√©es au d√©marrage
        window.addEventListener('load', function() {
            initializeNetwork();
            loadDefaultData();
        });
    </script>
</body>
</html>
